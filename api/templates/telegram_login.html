{% extends "base.html" %}

{% block title %}Telegram Login{% endblock %}

{% block content %}
<h1>ğŸ“± Telegram Account Login</h1>

{% if session_data %}
<!-- Already logged in -->
<div class="card">
    <h2>âœ… Active Session</h2>
    <table>
        <thead>
            <tr>
                <th>Property</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Phone</strong></td>
                <td><code>{{ session_data.phone }}</code></td>
            </tr>
            <tr>
                <td><strong>User ID</strong></td>
                <td><code>{{ session_data.user_id }}</code></td>
            </tr>
            <tr>
                <td><strong>Name</strong></td>
                <td>{{ session_data.first_name }} {{ session_data.last_name or '' }}</td>
            </tr>
            {% if session_data.username %}
            <tr>
                <td><strong>Username</strong></td>
                <td>@{{ session_data.username }}</td>
            </tr>
            {% endif %}
            <tr>
                <td><strong>Last Updated</strong></td>
                <td>{{ session_data.updated_at[:19] }}</td>
            </tr>
        </tbody>
    </table>

    <div style="margin-top: 1.5rem;">
        <form method="POST" style="display:inline;">
            <input type="hidden" name="action" value="logout">
            <button type="submit" class="btn-danger" onclick="return confirm('Logout from Telegram?');">
                ğŸšª Logout
            </button>
        </form>
    </div>
</div>

<div class="alert alert-success">
    âœ… <strong>Ready to Create Groups!</strong><br>
    Your Telegram session is saved with User ID: <code>{{ session_data.user_id }}</code><br>
    You can now use this account to create escrow groups in your bot!
</div>

{% else %}
<!-- Login Form -->
<div class="card">
    <h2>Login to Telegram</h2>

    {% if login_step == 'phone' %}
    <!-- Step 1: Phone Number -->
    <p style="color: #64748b; margin-bottom: 1.5rem;">Enter your phone number to receive a verification code.</p>
    <form method="POST">
        <input type="hidden" name="action" value="send_code">
        <div class="form-group">
            <label for="phone">Phone Number</label>
            <input type="text" id="phone" name="phone" placeholder="+1234567890" required autofocus>
            <small style="color: #64748b;">Include country code, e.g., +1 for US, +91 for India</small>
        </div>
        <button type="submit" class="btn-success">ğŸ“± Send Code</button>
    </form>

    {% elif login_step == 'code' %}
    <!-- Step 2: Verification Code -->
    <p style="color: #64748b; margin-bottom: 1.5rem;">
        Enter the verification code sent to <strong>{{ phone }}</strong>
    </p>
    <form method="POST">
        <input type="hidden" name="action" value="verify_code">
        <div class="form-group">
            <label for="code">Verification Code</label>
            <input type="text" id="code" name="code" placeholder="12345" required autofocus>
            <small style="color: #64748b;">Check your Telegram app or SMS</small>
        </div>
        <button type="submit" class="btn-success">âœ… Verify Code</button>
        <form method="POST" style="display:inline; margin-left: 0.5rem;">
            <input type="hidden" name="action" value="start_over">
            <button type="submit" class="btn-secondary">ğŸ”™ Start Over</button>
        </form>
    </form>

    {% elif login_step == 'password' %}
    <!-- Step 3: 2FA Password -->
    <p style="color: #64748b; margin-bottom: 1.5rem;">
        Your account has 2FA enabled. Enter your cloud password.
    </p>
    <form method="POST">
        <input type="hidden" name="action" value="verify_password">
        <div class="form-group">
            <label for="password">2FA Password</label>
            <input type="password" id="password" name="password" placeholder="Enter your password" required autofocus>
            <small style="color: #64748b;">This is your Telegram cloud password</small>
        </div>
        <button type="submit" class="btn-success">ğŸ” Verify Password</button>
        <form method="POST" style="display:inline; margin-left: 0.5rem;">
            <input type="hidden" name="action" value="start_over">
            <button type="submit" class="btn-secondary">ğŸ”™ Start Over</button>
        </form>
    </form>
    {% endif %}
</div>

<div class="card">
    <h2>ğŸ¯ What You Can Do After Login</h2>
    <ul style="margin-left: 1.5rem; margin-top: 1rem; color: #64748b;">
        <li><strong>Create Escrow Groups:</strong> Automatically create groups for each transaction</li>
        <li><strong>Manage Channels:</strong> Create and manage Telegram channels</li>
        <li><strong>Send Messages:</strong> Send automated messages as this account</li>
        <li><strong>Full API Access:</strong> Use complete Telegram API functionality</li>
    </ul>
</div>

<div class="card">
    <h2>â„¹ï¸ How This Works</h2>
    <ul style="margin-left: 1.5rem; margin-top: 1rem; color: #64748b;">
        <li>Your session is stored as a <strong>StringSession</strong> in the database</li>
        <li>No files needed - perfect for serverless Vercel!</li>
        <li>Session persists forever until you logout</li>
        <li>Your User ID is saved for creating groups</li>
        <li>Fully encrypted connection to Telegram</li>
    </ul>
</div>

<div class="alert alert-warning">
    ğŸ”’ <strong>Security:</strong> Your session data is encrypted. Never share your login code or password.
</div>
{% endif %}
{% endblock %}